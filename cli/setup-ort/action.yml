# https://docs.github.com/en/actions/reference/workflows-and-actions/metadata-syntax
name: "Setup ORT CLI"
description: "Setup the ORT CLI for use in a GitHub workflow."

inputs:
  ort-version:
    description: "The version of ORT to set up. Defaults to 'latest'."
    required: false

runs:
  # https://docs.github.com/en/actions/concepts/workflows-and-actions/custom-actions#types-of-actions
  using: "composite"
  steps:
  - name: "Download ORT CLI"
    # https://docs.github.com/en/actions/reference/workflows-and-actions/workflow-syntax#jobsjob_idstepsshell
    shell: "bash"
    env:
      ORT_VERSION: ${{ inputs.ort-version }}
    run: |
      if [ -z "$ORT_VERSION" -o "$ORT_VERSION" = "latest" ]; then
        ORT_VERSION=$(curl -sI https://github.com/oss-review-toolkit/ort/releases/latest \
          | grep -i "location:" | sed "s,.*/tag/,," | tr -d "\r\n")
      fi

      if [ -z "$ORT_VERSION" ]; then
        echo "::error::The ORT version must not be empty."
        exit 1
      fi

      ORT_HOME=$RUNNER_TOOL_CACHE/ort/$ORT_VERSION

      if [ ! -d "$ORT_HOME" ]; then
        mkdir -p "$ORT_HOME"
        echo "::notice::Setting up ORT version $ORT_VERSION in '$ORT_HOME'..."

        curl -sL https://github.com/oss-review-toolkit/ort/releases/download/$ORT_VERSION/ort-$ORT_VERSION.tgz \
          | tar -xz -C "$ORT_HOME" --strip-components=1
      else
        echo "::notice::ORT version $ORT_VERSION was already set up in '$ORT_HOME'."
      fi

      echo "$ORT_HOME/bin" >> "$GITHUB_PATH"
  - name: "Setup Java"
    uses: actions/setup-java@f2beeb24e141e01a676f977032f5a29d81c9e27e # v5.1.0
    with:
      distribution: "temurin"
      java-version: "21"
  - name: "Check ORT Requirements"
    uses: sschuberth/ort-github-actions/cli/requirements@main
    continue-on-error: true
